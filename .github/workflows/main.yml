name: Deploy to Amazon to ECR

on:
  push:
    branches:
      - staging

env:
  AWS_REGION: us-east-1                   
  ECR_REPOSITORY: lambdatesting                 

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.CPID }}
        aws-secret-access-key: ${{ secrets.CPPK }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
        
      run: |
        # Build a docker container and
        # push it to ECR so that it can
        docker build \
        -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
          .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        echo "::set-output name=image::$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        
    - name: check changes and deploy in EC2 server
      uses: appleboy/ssh-action@master
      with:
        key: ${{ secrets.STAGE_AWS_PK_A }}
        host: ${{ secrets.STAGE_AWS_HOST }}
        username: ${{ secrets.AWS_USER }}
        script: | 
          ls -lah
          aws ecr get-login-password --region us-east-1 | docker login -u AWS -p eyJwYXlsb2FkIjoiMHR1V09FQ09HNHNOc2hzeDFuQ3dodWROa096Q0VjK3h0Vk0xTCtXRk9YRVJyc2dObHNqU0hkTWYwRS83NmhvMWVVV0pNWUlyK2cvQTdsbDBEc1VUUm40OWZOS3RRNm9nWVE5dDF4UmdlY1RWd2ZvMkoxQWZwbGJoenowYkw1ZUc2ZEtwNkJHdm1IM0UrU2lvWllJanJjRDVYclFxc0drdTN6MXNOeE1UUnFpUU5kT2puaUxJczZSR05Zc2sxaWwyN1dYU1YvOEEwMjZxVVFFS3FyVFZESEFpdUpYc1FJWm8xbUVSUUJOVFFIdU1CVkg4NjFBeFloc3B1VS9VSC9qUjVWZEIwTGNvUVVqdUpXYTRVNVlyS280bXYwNnI2NHZrYjI2QXkyUHVmaFJkbklHQmg4bDJRRjlZRjlxTExUZm0xVXdmdlBaTXdPZUxUemxXZFV4RTFKejNxaDg2cGNPU3oxWktNUnhMemtTMjEzblV4Rk9URU96Sk0rOGlueGsraEtNUFIyUFFSdXQzQW1MNitNMzVLYWhIdmFlTkh2TXQwY3p2VVNvVjh5ajZLWEhnLzNZYzV0MUNJL1duTWVrZzdyamlYRzFjczV4bEM4c2dibGh6V096LzVYcUt0VmU0cklnNWtkL09FbjB0ZHBkQTdPSVhaZno2L3BCWDc2R1dhZkZXU2Z5U2drRGg0UEUzZXhEd3ZISnNCTnNWVVJad1Y3cENJYVg4TTNVczVXRTB2Nk5KbGl2QkFWblNaRXFyMzFINjRjSmJkK0ozRmhZZkxTK09hN2lyeVBaVlpCY3hPTEFud0JXSlVhTFp2QWROdVUyc1RNejZDRXdqVTRZV2J3OWQwS1FzWUFWMFpaWmVSK3d3L29PRUlKMVFqWTJ2MVQ3K2Q1WHJWbSs4MG1oWmNFYXpYaE0zWTFlZTcwVndYOFZyTGFTeGpSSDBwNDg3UU9PSnNBc2dVaVJ4MiszS3NGb3RrV1VCNE9aVDI1ODNOOGFFZUFqNGd4a1NmNUtOSXlmYXlzQzY1dmtKSXB6dmN2Q0hJUUFxUlpWZmNEUXB0Q0F5aFlleVl4UzlYS1N1d01HblVLL3k0QzJWRFhwUHhTNmZnRDhaUFdVQVRQVUFqSUM2UW44RFlTcjVSVXlkV2wvOHRHakRsS0J0TGRjTklWR1U3TENQWWhvOHZtMzFQei9XN09JMGQ5TmtDcS9ITVBmdVV6TGQvN3N5UWIvWTlIMVpJVVpKeno2VERmMnJVdmZsZG8rS2djZTVxdnR3ZWZkcE9yTkpyL0k4Q2RnLzNOa0ltcTQyTE93ZWxWbmJZV1M1MjRKdmpIRW10djZKOWxZeS9oQ3lHYXRQNjJYQkVJYTJMaG52UitJNHROK0trQT09IiwiZGF0YWtleSI6IkFRRUJBSGh3bTBZYUlTSmVSdEptNW4xRzZ1cWVla1h1b1hYUGU1VUZjZTlScTgvMTR3QUFBSDR3ZkFZSktvWklodmNOQVFjR29HOHdiUUlCQURCb0Jna3Foa2lHOXcwQkJ3RXdIZ1lKWUlaSUFXVURCQUV1TUJFRURPNVZKVkFGZkRrdGJ0QllXd0lCRUlBNzhOWkdMK0hST3ZtYjZpbzV5VHcrL3dTZEd0dFptZkE2OXkwYUdxQ1BaVktnTEJtSTMrdmFPclRaZWxPNExNQ0l5bXhSbVh4am9MVGszTEU9IiwidmVyc2lvbiI6IjIiLCJ0eXBlIjoiREFUQV9LRVkiLCJleHBpcmF0aW9uIjoxNjY1Nzg3NTQxfQ==https://451010677902.dkr.ecr.us-east-1.amazonaws.com
          docker pull 451010677902.dkr.ecr.us-east-1.amazonaws.com/$ECR_REPOSITORY/$IMAGE_TAG

